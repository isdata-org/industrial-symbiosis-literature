"use strict";importScripts("utils.min.js");var my={conditional:{},conditional_total:{},doc_categories:{}},doc_topics_matrix,total_tokens,topic_docs,doc_topics,topic_conditional,conditional_total,topic_docs_conditional;doc_topics_matrix=function(t){var i={},o=t;if(o.p&&o.p.length){o.n=o.p.length-1}o.get=function(t,i){var o,a,n,e;if(!this.x){return undefined}if(t===undefined){return this}if(i===undefined){e=[];for(n=0;n<this.n;n+=1){e.push(this.get(t,n))}return e}o=this.p[i];a=utils.bisect_left(this.i.slice(o,this.p[i+1]),t);e=this.i[a+o]===t?this.x[a+o]:0;return e};o.row_sum=function(t){var o,a,n;if(!this.x){return undefined}if(!i.row_sum){i.row_sum=[]}if(t===undefined){for(a=0;a<this.n;a+=1){for(n=this.p[a];n<this.p[a+1];n+=1){if(i.row_sum[this.i[n]]===undefined){i.row_sum[this.i[n]]=0}i.row_sum[this.i[n]]+=this.x[n]}}return i.row_sum}if(!i.row_sum[t]){o=0;for(a=0;a<this.n;a+=1){o+=this.get(t,a)}i.row_sum[t]=o}return i.row_sum[t]};o.col_sum=function(t){var o;if(!i.col_sum){i.col_sum=[]}if(t===undefined){for(o=0;o<this.n;o+=1){this.col_sum(o)}return i.col_sum}if(!i.col_sum[t]){i.col_sum[t]=0;for(o=this.p[t];o<this.p[t+1];o+=1){i.col_sum[t]+=this.x[o]}}return i.col_sum[t]};return o};total_tokens=function(){var t,i=0;for(t=0;t<my.dt.x.length;t+=1){i+=my.dt.x[t]}return i};topic_docs=function(t,i){return topic_docs_conditional(t,undefined,undefined,i)};doc_topics=function(t,i){var o=[],a,n;for(a=0;a<my.dt.n;a+=1){n=my.dt.get(t,a);if(n>0){o.push({topic:a,weight:n})}}o.sort(function(t,i){return utils.desc(t.weight,i.weight)||utils.desc(t.t,i.t)});return utils.shorten(o,i,function(t,i){return t[i].weight})};topic_conditional=function(t,i){var o,a,n;if(!my.conditional[t]){my.conditional[t]={}}if(i===undefined){o=[];for(a=0;a<my.dt.n;a+=1){o.push(topic_conditional(t,a))}return o}if(my.conditional[t][i]){return my.conditional[t][i]}o={};for(a=my.dt.p[i];a<my.dt.p[i+1];a+=1){n=my.doc_categories[t][my.dt.i[a]];if(o[n]){o[n]+=my.dt.x[a]}else{o[n]=my.dt.x[a]}}for(n in o){if(o.hasOwnProperty(n)){o[n]/=conditional_total(t,n)}}my.conditional[t][i]=o;return o};conditional_total=function(t,i){var o,a,n;if(!my.conditional_total[t]){o={};for(n=0;n<my.dt.i.length;n+=1){a=my.doc_categories[t][my.dt.i[n]];if(o[a]){o[a]+=my.dt.x[n]}else{o[a]=my.dt.x[n]}}my.conditional_total[t]=o}return i!==undefined?my.conditional_total[t][i]:my.conditional_total[t]};topic_docs_conditional=function(t,i,o,a){var n=my.dt.p[t],e=my.dt.p[t+1],s,d=[],c,r,u,l=[];for(s=n;s<e;s+=1){if(i===undefined||my.doc_categories[i][my.dt.i[s]]===o){d.push({doc:my.dt.i[s],frac:my.dt.x[s]/my.dt.row_sum(my.dt.i[s]),weight:my.dt.x[s]})}}if(a>=d.length){d.sort(function(t,i){return utils.desc(t.frac,i.frac)||utils.desc(t.doc,i.doc)});return d}l=d.slice(0,a).sort(function(t,i){return utils.asc(t.frac,i.frac)||utils.asc(t.doc,i.doc)});c=utils.bisector_left(function(t){return t.frac});for(u=a;u<d.length;u+=1){r=c(l,d[u].frac);if(r>0){l.splice(r,0,d[u]);l.shift()}else if(l[0].frac===d[u].frac){l.unshift(d[u])}}return utils.shorten(l.reverse(),a,function(t,i){return t[i].frac})};onmessage=function(t){if(t.data.what==="set_dt"){my.dt=doc_topics_matrix(t.data.dt);if(my.dt){my.dt.row_sum()}postMessage({what:"set_dt",result:my.dt!==undefined})}else if(t.data.what==="set_doc_categories"){my.doc_categories[t.data.v]=t.data.keys;postMessage({what:"set_doc_categories",result:my.doc_categories[t.data.v]!==undefined})}else if(t.data.what==="total_tokens"){postMessage({what:"total_tokens",result:total_tokens()})}else if(t.data.what==="topic_docs"){postMessage({what:"topic_docs/"+t.data.t+"/"+t.data.n,result:topic_docs(t.data.t,t.data.n)})}else if(t.data.what==="doc_topics"){postMessage({what:"doc_topics/"+t.data.d+"/"+t.data.n,result:doc_topics(t.data.d,t.data.n)})}else if(t.data.what==="topic_total"){postMessage({what:"topic_total/"+t.data.t,result:my.dt.col_sum(t.data.t==="all"?undefined:t.data.t)})}else if(t.data.what==="topic_conditional"){postMessage({what:"topic_conditional/"+t.data.v+"/"+t.data.t,result:topic_conditional(t.data.v,t.data.t==="all"?undefined:t.data.t)})}else if(t.data.what==="conditional_total"){postMessage({what:"conditional_total/"+t.data.v+"/"+t.data.key,result:conditional_total(t.data.v,t.data.key==="all"?undefined:t.data.key)})}else if(t.data.what==="topic_docs_conditional"){postMessage({what:"topic_docs_conditional/"+t.data.t+"/"+t.data.v+"/"+t.data.key+"/"+t.data.n,result:topic_docs_conditional(t.data.t,t.data.v,t.data.key,t.data.n)})}else{postMessage({what:"error"})}};